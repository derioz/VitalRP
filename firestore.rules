rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user's email matches the document ID (case-insensitive)
    function isOwner(email) {
      return isAuthenticated() && request.auth.token.email.lower() == email.lower();
    }
    
    // Fetch user data from 'users' collection
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.token.email.lower())).data;
    }
    
    // Check roles
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    function isSuperAdmin() {
      // Hardcoded fallback for safety (matches AuthProvider.tsx) + DB role check
      return (isAuthenticated() && request.auth.token.email.lower() == 'tx.davidj@gmail.com') 
             || hasRole('superadmin') 
             || hasRole('owner');
    }
    
    function isAdmin() {
      return isSuperAdmin() || hasRole('admin');
    }
    
    function isEditor() {
      return isAdmin() || hasRole('editor');
    }

    // --- Collection Rules ---

    // USERS Collection
    // Document ID matches user email (lowercase)
    match /users/{email} {
      // Allow authenticated users to read their own profile
      // Allow admins to read all profiles (for user management)
      allow get: if isOwner(email) || isAdmin();
      allow list: if isAdmin();

      // Allow new users to create their profile with default 'user' role
      // This prevents users from giving themselves admin roles on creation
      allow create: if isOwner(email) 
                    && request.resource.data.role == 'user';

      // Allow users to update their own non-role fields (displayName, photoURL, etc.)
      // verifying that 'role' field is NOT in the list of updated keys
      allow update: if isOwner(email) 
                    && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));

      // Admins have full write access (including role changes and deletions)
      allow write: if isAdmin();
    }

    // GALLERY Collection
    match /gallery/{imageId} {
      allow read: if true; // Public access
      allow write: if isEditor(); // Editors and Admins can manage gallery
    }

    // STAFF Collection
    match /staff/{staffId} {
      allow read: if true; // Public access
      allow write: if isAdmin(); // Only Admins can manage staff
    }

    // CONFIG Collection
    // Used for site-wide settings like 'maintenanceMode'
    match /config/{docId} {
      allow read: if true; // Public access
      allow write: if isAdmin(); // Only Admins can change config
    }

    // Default deny for everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
